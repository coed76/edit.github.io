<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Formulario de Prematr√≠cula 2026</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;position:relative}
#particles-canvas{position:fixed;inset:0;z-index:1;pointer-events:none}
.form-container{z-index:10;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:24px;padding:45px;max-width:740px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.header{text-align:center;margin-bottom:32px}
.logo-container{width:140px;height:140px;margin:0 auto 10px;background:#fff;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 25px rgba(40,167,69,.3)}
.logo-container img{width:100%;height:100%;object-fit:cover;border-radius:50%}
h1{color:#2d3748;font-size:2em}
h2{color:#667eea;font-size:1.05em}
.year-badge{display:inline-block;margin-top:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:6px 16px;border-radius:20px;font-weight:600}
.form-group{margin-bottom:18px}
label{display:block;font-weight:600;color:#4a5568;margin-bottom:6px}
input[type="text"],select{width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:12px}
input[readonly]{background:#f7fafc}
.top-row{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px}
.inline-group{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px}
.contact-group{display:grid;grid-template-columns:2fr 1fr;gap:12px}
.checkbox-group{display:flex;align-items:center;padding-top:8px}
.checkbox-wrapper{display:flex;align-items:center;gap:8px;cursor:pointer}
.custom-checkbox{width:22px;height:22px;border:2px solid #e2e8f0;border-radius:6px;display:flex;align-items:center;justify-content:center}
.custom-checkbox.checked{background:linear-gradient(135deg,#667eea,#764ba2);border-color:#667eea}
.custom-checkbox svg{width:14px;height:14px;fill:#fff;opacity:0}
.custom-checkbox.checked svg{opacity:1}
.actions{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
.btn{border:none;color:#fff;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;display:inline-flex;gap:10px;align-items:center}
.btn svg{width:20px;height:20px;fill:#fff}
.btn-whatsapp{background:linear-gradient(135deg,#25D366,#128C7E)}
.btn-pdf{background:linear-gradient(135deg,#667eea,#764ba2)}
.success-message{position:fixed;top:18px;right:18px;background:#fff;padding:14px 18px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.2);display:none;gap:10px;z-index:1000}
.success-message.show{display:flex}
@media(max-width:768px){.top-row,.inline-group,.contact-group{grid-template-columns:1fr}}
</style>
</head>
<body>
<canvas id="particles-canvas"></canvas>

<div class="form-container">
  <div class="header">
    <div class="logo-container">
      <img src="https://i.imgur.com/ugoJzRX.jpeg" alt="Logo Complejo Educativo Cant√≥n San Isidro">
    </div>
    <h1>PREMATR√çCULA</h1>
    <h2>COMPLEJO EDUCATIVO CANT√ìN SAN ISIDRO</h2>
    <span class="year-badge">A√ëO 2026</span>
  </div>

  <form id="prematricula-form" autocomplete="off">
    <div class="top-row">
      <div class="form-group">
        <label for="nie">NIE del Estudiante *</label>
        <input type="text" id="nie" maxlength="10" placeholder="Ej: 1234567890">
      </div>
      <div class="form-group">
        <label for="fecha-registro">Fecha</label>
        <input type="text" id="fecha-registro" readonly>
      </div>
      <div class="form-group">
        <label for="hora-registro">Hora</label>
        <input type="text" id="hora-registro" readonly>
      </div>
    </div>

    <div class="form-group">
      <label for="nombre-completo">Nombre Completo *</label>
      <input type="text" id="nombre-completo">
    </div>

    <div class="form-group">
      <label for="nombre-responsable">Nombre del Responsable *</label>
      <input type="text" id="nombre-responsable">
    </div>

    <div class="form-group">
      <label for="dui">N√∫mero de Documento (DUI)</label>
      <input type="text" id="dui" placeholder="########-#">
    </div>

    <div class="inline-group">
      <div class="form-group">
        <label for="reserva-matricula">Reserva Matr√≠cula en (Grado) *</label>
        <select id="reserva-matricula">
          <option value="" disabled selected>Seleccione el nivel</option>
          <optgroup label="Parvularia">
            <option>Parvularia 4</option>
            <option>Parvularia 5</option>
            <option>Parvularia 6</option>
          </optgroup>
          <optgroup label="Educaci√≥n B√°sica">
            <option>Primer Grado</option>
            <option>Segundo Grado</option>
            <option>Tercer Grado</option>
            <option>Cuarto Grado</option>
            <option>Quinto Grado</option>
            <option>Sexto Grado</option>
            <option>S√©ptimo Grado</option>
            <option>Octavo Grado</option>
            <option>Noveno Grado</option>
          </optgroup>
          <optgroup label="Bachillerato">
            <option>Primer A√±o General</option>
            <option>Primer A√±o T√©cnico</option>
            <option>Segundo A√±o General</option>
            <option>Segundo A√±o T√©cnico</option>
            <option>Tercer A√±o T√©cnico</option>
          </optgroup>
        </select>
      </div>

      <div class="form-group">
        <label for="turno">Turno *</label>
        <select id="turno">
          <option value="" disabled selected>Seleccione el turno</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
        </select>
      </div>

      <div class="form-group">
        <label for="seccion">Secci√≥n *</label>
        <select id="seccion">
          <option value="" disabled selected>Seleccione una opci√≥n</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="Jornada">Jornada</option>
        </select>
      </div>
    </div>

    <div class="contact-group">
      <div class="form-group">
        <label for="numero-contacto">N√∫mero de Contacto *</label>
        <input type="text" id="numero-contacto" placeholder="7890-1234" maxlength="9">
      </div>
      <div class="checkbox-group">
        <div class="checkbox-wrapper" id="whatsapp-box">
          <div class="custom-checkbox" id="whatsapp-checkbox">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
          </div>
          <span class="checkbox-label">Tiene WhatsApp</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <button type="button" id="btn-enviar" class="btn btn-whatsapp">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347Z"/></svg>
        Enviar por WhatsApp
      </button>
      <button type="button" id="btn-pdf" class="btn btn-pdf">
        <svg viewBox="0 0 24 24"><path d="M19 3H5a2 2 0 00-2 2v14l4-4h12a2 2 0 002-2V5a2 2 0 00-2-2zM8 9h8v2H8V9zm0 4h5v2H8v-2z"/></svg>
        Descargar PDF (Carta)
      </button>
    </div>
  </form>
</div>

<div class="success-message" id="success-message">
  <span>¬°Operaci√≥n realizada!</span>
</div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ====== CONFIG ====== */
const API_BASE = 'http://localhost:8080'; // ‚Ü©Ô∏è Cambia si tu backend WhatsApp est√° en otra URL

/* ====== Fecha/Hora ====== */
const fechaEl = document.getElementById('fecha-registro');
const horaEl  = document.getElementById('hora-registro');
function pad(n){ return n.toString().padStart(2,'0'); }
function tickDateTime(){
  const now = new Date();
  fechaEl.value = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()}`;
  horaEl.value  = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
}
tickDateTime(); setInterval(tickDateTime, 1000);

/* ====== Inputs con m√°scaras ====== */
document.getElementById('numero-contacto').addEventListener('input', function(){
  let v = this.value.replace(/\D/g,'').slice(0,8);
  if (v.length > 4) v = v.slice(0,4) + '-' + v.slice(4);
  this.value = v;
});
document.getElementById('dui').addEventListener('input', function(){
  let v = this.value.replace(/\D/g,'').slice(0,9);
  if (v.length > 8) v = v.slice(0,8) + '-' + v.slice(8);
  this.value = v;
});

/* ====== Checkbox WhatsApp ====== */
let whatsappChecked = false;
document.getElementById('whatsapp-box').addEventListener('click', () => {
  whatsappChecked = !whatsappChecked;
  document.getElementById('whatsapp-checkbox').classList.toggle('checked', whatsappChecked);
});

/* ====== Recolectar / Validar ====== */
function datosForm(){
  return {
    nie: document.getElementById('nie').value.trim(),
    nombre: document.getElementById('nombre-completo').value.trim(),
    responsable: document.getElementById('nombre-responsable').value.trim(),
    dui: document.getElementById('dui').value.trim(),
    grado: document.getElementById('reserva-matricula').value,
    turno: document.getElementById('turno').value,
    seccion: document.getElementById('seccion').value,
    contacto: document.getElementById('numero-contacto').value.trim(),
    fecha: fechaEl.value, hora: horaEl.value,
    whatsapp: whatsappChecked ? 'S√≠' : 'No'
  };
}
function validar(d){
  if(!d.nie || !d.nombre || !d.responsable || !d.grado || !d.seccion || !d.contacto || !d.fecha || !d.hora){
    alert('‚ö†Ô∏è Complete todos los campos obligatorios'); return false;
  }
  if(d.dui && !/^\d{8}-\d$/.test(d.dui)){ alert('‚ö†Ô∏è DUI inv√°lido'); return false; }
  if(!/^\d{4}-\d{4}$/.test(d.contacto)){ alert('‚ö†Ô∏è Tel√©fono inv√°lido'); return false; }
  return true;
}

/* ====== PDF tama√±o carta ====== */
async function generarPDFCarta(d){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'letter' }); // 612x792 pt (Carta)
  const margin = 48; let y = margin;

  doc.setFont('helvetica','bold'); doc.setFontSize(18);
  doc.text('PREMATR√çCULA 2026', margin, y); y += 20;
  doc.setFont('helvetica','normal'); doc.setFontSize(12);
  doc.text('COMPLEJO EDUCATIVO CANT√ìN SAN ISIDRO', margin, y); y += 14;
  doc.setDrawColor(102,126,234); doc.line(margin, y+8, 612 - margin, y+8); y += 26;

  doc.setFont('helvetica','bold'); doc.text('Registro', margin, y); y += 16;
  doc.setFont('helvetica','normal');
  doc.text(`Fecha: ${d.fecha}    Hora: ${d.hora}`, margin, y); y += 20;

  doc.setFont('helvetica','bold'); doc.text('Datos del Estudiante', margin, y); y += 16;
  doc.setFont('helvetica','normal');
  doc.text(`NIE: ${d.nie}`, margin, y); y += 16;
  doc.text(`Nombre: ${d.nombre}`, margin, y); y += 20;

  doc.setFont('helvetica','bold'); doc.text('Responsable', margin, y); y += 16;
  doc.setFont('helvetica','normal');
  doc.text(`Nombre: ${d.responsable}`, margin, y); y += 16;
  if(d.dui){ doc.text(`DUI: ${d.dui}`, margin, y); y += 16; }
  doc.text(`Contacto: ${d.contacto}`, margin, y); y += 16;
  doc.text(`WhatsApp: ${d.whatsapp}`, margin, y); y += 20;

  doc.setFont('helvetica','bold'); doc.text('Informaci√≥n Acad√©mica', margin, y); y += 16;
  doc.setFont('helvetica','normal');
  doc.text(`Grado: ${d.grado}`, margin, y); y += 16;
  doc.text(`Turno: ${d.turno || '‚Äî'}`, margin, y); y += 16;
  doc.text(`Secci√≥n: ${d.seccion}`, margin, y); y += 24;

  doc.setDrawColor(220); doc.line(margin, 792 - margin - 24, 612 - margin, 792 - margin - 24);
  doc.setFontSize(10); doc.setTextColor(120);
  doc.text('Documento generado autom√°ticamente desde el formulario de prematr√≠cula.', margin, 792 - margin);

  const filename = `Prematricula_${d.nie||'sinNIE'}_${Date.now()}.pdf`;
  doc.save(filename); // descarga local

  const dataUrl = doc.output('datauristring'); // para backend WhatsApp
  return { filename, dataUrl };
}

/* ====== WhatsApp Cloud API (backend) ====== */
async function enviarWhatsAppDocumento(toE164, filename, pdfDataUrl) {
  const resp = await fetch(`${API_BASE}/api/whatsapp/send`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      to: toE164,           // ej "50379677031"
      filename,             // ej "Prematricula_...pdf"
      caption: 'Prematr√≠cula 2026',
      pdfBase64: pdfDataUrl // "data:application/pdf;base64,...."
    })
  });
  if (!resp.ok) {
    const err = await resp.json().catch(()=>({}));
    throw new Error('Error API WhatsApp: ' + JSON.stringify(err));
  }
  return resp.json();
}

/* ====== Util: formatea a E.164 SV ====== */
function telefonoSVaE164(t){ // t: "7890-1234" -> "50378901234"
  const digits = (t||'').replace(/\D/g,'').slice(0,8);
  return digits.length === 8 ? `503${digits}` : '';
}

/* ====== Botones ====== */
document.getElementById('btn-pdf').addEventListener('click', async ()=>{
  const d = datosForm(); if(!validar(d)) return;
  await generarPDFCarta(d); // siempre tama√±o carta
});

document.getElementById('btn-enviar').addEventListener('click', async ()=>{
  try{
    const d = datosForm(); if(!validar(d)) return;

    // Mensaje de texto (para abrir WhatsApp web con chat)
    const lineaDUI = d.dui ? `ü™™ DUI: ${d.dui}\n` : '';
    const mensaje =
`*PREMATR√çCULA 2026*
üè´ COMPLEJO EDUCATIVO CANT√ìN SAN ISIDRO

üìÖ *Registro*
Fecha: ${d.fecha}
Hora: ${d.hora}

üìã *Datos del Estudiante*
üë§ NIE: ${d.nie}
üßí Nombre: ${d.nombre}

üë®‚Äçüë©‚Äçüëß *Responsable*
üë§ Nombre: ${d.responsable}
${lineaDUI}üì± Contacto: ${d.contacto}
üí¨ WhatsApp: ${d.whatsapp}

üìö *Informaci√≥n Acad√©mica*
üéì Grado: ${d.grado}
‚è∞ Turno: ${d.turno || '‚Äî'}
üìÇ Secci√≥n: ${d.seccion}`;

    if (d.grado === 'Noveno Grado') {
      // 1) Generar PDF Carta
      const { filename, dataUrl } = await generarPDFCarta(d);

      // 2) Enviar documento por Cloud API al n√∫mero fijo
      const numeroDestino = '50379677031'; // sin '+'
      await enviarWhatsAppDocumento(numeroDestino, filename, dataUrl);

      // 3) Tambi√©n abrir WhatsApp Web con el n√∫mero fijo (tu snippet integrado)
      const telefono = numeroDestino;
      const urlWhatsApp = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;
      window.open(urlWhatsApp, '_blank');

      alert('‚úÖ PDF generado (Carta) y enviado por WhatsApp Cloud API. Se abri√≥ WhatsApp Web con el chat.');
    } else {
      // Otros grados: abrir WhatsApp Web al n√∫mero de contacto del formulario (si existe)
      const telefono = telefonoSVaE164(d.contacto) || ''; // E.164 SV
      const urlWhatsApp = telefono
        ? `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`
        : `https://web.whatsapp.com/send?text=${encodeURIComponent(mensaje)}`;
      window.open(urlWhatsApp, '_blank');
    }

    // Toast
    const msg=document.querySelector('.success-message');
    msg.classList.add('show'); setTimeout(()=>msg.classList.remove('show'),3000);
  } catch (e) {
    console.error(e);
    alert('‚ùå No se pudo completar el env√≠o: ' + e.message);
  }
});
</script>
</body>
</html>
